<html lang="en" meta charset="UTF-8">

<head>
<!--jquery code to get the id of the year-link pressed-->
<script src="jquery.min.js"></script>
<script>
$(document).ready(function(){
    $("p").click(function(){
        display_year = $(this).attr('id');
		generateVis()
		Charts()});
});
</script>

    <meta charset="utf-8">
    <script type="text/javascript" src="./d3/d3.v4.js" charset="utf-8"></script>
    <style type="text/css">
    p{
    text-decoration: underline;
    text-decoration-color: blue;
    }
    p:hover {cursor: pointer;}
        /*CSS properties for axis */
        .axis path,
        .axis line {
            fill: none;
            stroke: darkgray;
            stroke-width: 1.5px;
        }

        /*CSS properties for the Year Text Floating on the graph*/

        .year {
            font-size: 150px;
            font-family: "Times New Roman";  
            opacity: 0.25
        }
        /*CSS properties for the Grid lines on the chart*/
        .grid line {
            stroke: lightgrey;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }
        .grid path {
            stroke-width: 0;
        }
        /*CSS Properties for text on the webpage*/
        .axis text {
            font-family: "Calibri, cursive";
            font-size: 11px;
        }
        /*CSS Properties for play button*/
        #play-button {
            position: absolute;
            background: black;
            
            color: white;
            margin-left: 7.5%;
            margin-bottom: 5%;
            padding: 0 12px;
            width: 60px;
            cursor: pointer;
            height: 30px;
        }
    
    </style>
    <h2>Channeling Hans</h2>
</head>

<body>
<!-- script to represent each year --> 
<div>
<p style="display:inline" id='1900'>1900</p>
<p style="display:inline" id='1910'>1910</p>
<p style="display:inline" id='1920'>1920</p>
<p style="display:inline" id='1930'>1930</p>
<p style="display:inline" id='1940'>1940</p>
<p style="display:inline" id='1950'>1950</p>
<p style="display:inline" id='1951'>1951</p>
<p style="display:inline" id='1952'>1952</p>
<p style="display:inline" id='1953'>1953</p>
<p style="display:inline" id='1954'>1954</p>
<p style="display:inline" id='1955'>1955</p>
<p style="display:inline" id='1956'>1956</p>
<p style="display:inline" id='1957'>1957</p>
<p style="display:inline" id='1958'>1958</p>
<p style="display:inline" id='1959'>1959</p>
<p style="display:inline" id='1960'>1960</p>
<p style="display:inline" id='1961'>1961</p>
<p style="display:inline" id='1962'>1962</p>
<br>
<p style="display:inline" id='1963'>1963</p>
<p style="display:inline" id='1964'>1964</p>
<p style="display:inline" id='1965'>1965</p>
<p style="display:inline" id='1966'>1966</p>
<p style="display:inline" id='1967'>1967</p>
<p style="display:inline" id='1968'>1968</p>
<p style="display:inline" id='1969'>1969</p>
<p style="display:inline" id='1970'>1970</p>
<p style="display:inline" id='1971'>1971</p>
<p style="display:inline" id='1972'>1972</p>
<p style="display:inline" id='1973'>1973</p>
<p style="display:inline" id='1974'>1974</p>
<p style="display:inline" id='1975'>1975</p>
<p style="display:inline" id='1976'>1976</p>
<p style="display:inline" id='1977'>1977</p>
<p style="display:inline" id='1978'>1978</p>
<p style="display:inline" id='1979'>1979</p>
<p style="display:inline" id='1980'>1980</p>
<br>
<p style="display:inline" id='1981'>1981</p>
<p style="display:inline" id='1982'>1982</p>
<p style="display:inline" id='1983'>1983</p>
<p style="display:inline" id='1984'>1984</p>
<p style="display:inline" id='1985'>1985</p>
<p style="display:inline" id='1986'>1986</p>
<p style="display:inline" id='1987'>1987</p>
<p style="display:inline" id='1988'>1988</p>
<p style="display:inline" id='1989'>1989</p>
<p style="display:inline" id='1990'>1990</p>
<p style="display:inline" id='1991'>1991</p>
<p style="display:inline" id='1992'>1992</p>
<p style="display:inline" id='1993'>1993</p>
<p style="display:inline" id='1994'>1994</p>
<p style="display:inline" id='1995'>1995</p>
<p style="display:inline" id='1996'>1996</p>
<p style="display:inline" id='1997'>1997</p>
<p style="display:inline" id='1998'>1998</p>
<br>
<p style="display:inline" id='1999'>1999</p>
<p style="display:inline" id='2000'>2000</p>
<p style="display:inline" id='2001'>2001</p>
<p style="display:inline" id='2002'>2002</p>
<p style="display:inline" id='2003'>2003</p>
<p style="display:inline" id='2004'>2004</p>
<p style="display:inline" id='2005'>2005</p>
<p style="display:inline" id='2006'>2006</p>
<p style="display:inline" id='2007'>2007</p>
<p style="display:inline" id='2008'>2008</p>
<p style="display:inline" id='2009'>2009</p>
<p style="display:inline" id='2010'>2010</p>
<p style="display:inline" id='2011'>2011</p>
<p style="display:inline" id='2012'>2012</p>
<p style="display:inline" id='2013'>2013</p>
<p style="display:inline" id='2014'>2014</p>
<p style="display:inline" id='2015'>2015</p>
<p style="display:inline" id='2016'>2016</p>
</div>   
<br>
<div>
<label for="year">Country  <select Id = "country"></select>
</div>
<br>
<div>
        <button id="play-button">Play</button>
    
        <input type="submit" id="year">        
</div>
    <table border="0">
        <tr>
            <td rowspan="4"><div id="hans"></div></td>
            <td><div id="reg" ></div></td>
            </tr> 
            <tr>
            <td><div id="govt" ></div></td>
        </tr>
    </table>
  
    </div>
    <div>
        <script type="text/javascript">
            var dataset;
            // Margins and other dimensions for bubble chart
            var margin = {
                top: 20,
                right: 10,
                bottom: 35,
                left: 35
            };
            var outer_width = 700;
            var outer_height = 400;
            var svg_width = outer_width - margin.left - margin.right;
            var svg_height = outer_height - margin.top - margin.bottom;            
            var yScale, xScale, rScale, xAxis, yAxis, color;

            // Margins and other dimensions for bar charts
            var margin_bars = {
                top: 20,
                right: 10,
                bottom: 30,
                left: 170
            };
            var playAnimation;
            var outer_width_bar = 450;
            var outer_height_bar = 300;
            var svg_width_bar = outer_width_bar - margin_bars.left - margin_bars.right;
            var svg_height_bar = outer_height_bar - margin_bars.top - margin_bars.bottom;
            
            var moving = false;
            var display_year = 1900;
            var filtered_dataset;

            // svg for the Hans Rosling bubble chart
            var svg = d3.select("#hans")
                .append("svg")
                .attr("width", svg_width + margin.left + margin.right)
                .attr("height", svg_height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

				
            // svg for the number of countries per region chart
            var svg1 = d3.select("#reg")
                .append("svg")
                .attr("width", svg_width_bar + margin_bars.left + margin_bars.right)
                .attr("height", svg_height_bar + margin_bars.top + margin_bars.bottom)
                .append("g")
                .attr("transform", "translate(" + margin_bars.left + "," + margin_bars.top + ")")
                .attr("class", "chart");
            
			// svg for number of countries for each government type chart
            var svg2 = d3.select("#govt")
                .append("svg")
                .attr("width", svg_width_bar     + margin_bars.left + margin_bars.right)
                .attr("height", svg_height_bar + margin_bars.top + margin_bars.bottom)
                .append("g")
                .attr("transform", "translate(" + margin_bars.left + "," + margin_bars.top + ")")
            
      regionSelect = '';
     
        // filter the dataset by region.
        function regionFilter(value) {
			if (regionSelect == '')
				return value;
			else
				s = value.Region;
				return (s.includes(regionSelect));
		}
            
		// function that filters data by year.
        function yearFilter(value) {
            return (value.Year == display_year)
        }

           
            function Variables() {
                dataset.forEach(function(d) {
                    d.Population = +d.Population;
                });
                dataset.forEach(function(d) {
                    d.GDP = +d.GDP;
                });
                dataset.forEach(function(d) {
                    d.LifeExp = +d.LifeExp;
                });
				
                //scaling and axis for bar chart of regions
                yScaleBarhans = d3.scaleBand()
                .range([0, svg_height_bar])
                .paddingInner(0.25)
                .paddingOuter(0.25);				
				xScaleBarhans = d3.scaleLinear()
                     .range([0, svg_width_bar]);
				yAxisBarhans = d3.axisLeft()
                  .scale(yScaleBarhans);
                xAxisBarhans = d3.axisBottom()
                                 .scale(xScaleBarhans)
                                 .ticks(10);

				//scaling and axis for bar chart of governments
                yScaleBarreg = d3.scaleBand()
                .range([0, svg_height_bar])
                .paddingInner(0.25)
                .paddingOuter(0.25);				
                xScaleBarreg = d3.scaleLinear()
                     .range([0, svg_width_bar]);
				yAxisBarreg = d3.axisLeft()
                  .scale(yScaleBarreg);
				xAxisBarreg = d3.axisBottom()
                                  .scale(xScaleBarreg)
                                  .ticks(12);
								  
                // defining bar chart for number of countries in Region.
                svg1.append("g")
                    .attr("id", "y-axis1")
                    .attr("class", "axis");
        
                svg1.append("g")
                    .attr("class", "axis")
                    .attr("id", "x-axis1")
                    .attr("transform", "translate(0," + svg_height_bar + ")");
                
                svg1.append("text")
                    .attr("x", svg_width_bar / 2.5 + 25 )
                    .attr("y", svg_height_bar + margin_bars.bottom)
                    .style("text-anchor", "middle")
                    .attr("font-family", "Arial Black")
                    .text("Number Of Countries")
                    .attr("opacity",1);
                        
                svg1.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 50 - margin_bars.left)
                    .attr("x", 0 - (svg_height_bar / 2))
                    .attr("dy", "0.7em")
                    .attr("opacity", 1)
                    .attr("font-family", "Arial Black")
                    .style("text-anchor", "middle")
                    .text("REGION");

				// defining bar chart for government type. 
                svg2.append("g")
                    .attr("id", "y-axis2")
                    .attr("class", "axis");

                svg2.append("g")
                    .attr("class", "axis")
                    .attr("id", "x-axis2")
                    .attr("transform", "translate(0," + svg_height_bar + ")");
                
                svg2.append("text")
                    .attr("x", svg_width_bar / 2.5 + 25 )
                    .attr("y", svg_height_bar + margin_bars.bottom)
                    .style("text-anchor", "middle")
                    .attr("font-family", "Arial Black")
                    .text("Number Of Countries")
                    .attr("opacity",1);
                
                svg2.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 50 - margin_bars.left)
                    .attr("x", 0 - (svg_height_bar / 2)+10)
                    .attr("dy", "0.7em")
                    .attr("opacity", 1)
                    .attr("font-family", "Arial Black")
                    .style("text-anchor", "middle")
                    .text("GOVERNMENT TYPE");

                // Life expectancy scale for bubble chart
                yScale = d3.scaleLinear()
                    .domain([15, 90])
                    .range([svg_height, 0]);


                // GDP scale for bubble chart
                xScale = d3.scaleLog()
                    .domain([135, 183000])
                    .range([0, svg_width]);

				// Radius scale according to the population	
                rScale = d3.scaleLinear()
                    .domain([15507, 1376048943])
                    .range([2, 45]);

                // Create x axis connected to x scale
                xAxis = d3.axisBottom()
                  .scale(xScale)
                  .ticks(7, d3.format(",d"));

                svg.append("text")
                    .attr("x", svg_width / 2.5 + margin.left)
                    .attr("y", svg_height + margin.bottom - 3)
                    .style("text-anchor", "middle")
                    .attr("font-family", "Arial Black")
                    .text("GDP")
                    .attr("opacity",1);

				// Create y axis connected to y scale
                yAxis = d3.axisLeft()
                .scale(yScale)
                .ticks(7, d3.format(",d"));
				
				svg.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0 - margin.left)
                    .attr("x", 0 - (svg_height / 2))
                    .attr("dy", "0.7em")
                    .attr("opacity", 1)
                    .attr("font-family", "Arial Black")
                    .style("text-anchor", "middle")
                    .text("Life expectancy");

				//function to make a grid
                function x_grid() {return d3.axisTop(xScale).ticks(3,d3.format(",d"));}
                function y_grid() {return d3.axisLeft(yScale).ticks(5)}
                svg.append("g").attr("class", "grid").call(y_grid().tickSize(-svg_width).tickFormat(""));
                svg.append("g").attr("class", "grid").call(x_grid().tickSize(-svg_height).tickFormat(""));
                                
                svg.append("g")
                    .attr("class", "axis")
                    .attr("transform", "translate(0," + svg_height + ")")
                    .call(xAxis);

               
                svg.append("g")
                    .attr("class", "axis")
                    .call(yAxis);
        
				//display year in the background
                svg.append("text")
                    .attr("y", svg_height / 1.8)
                    .attr("x", svg_width / 2)
                    .style("text-anchor", "end")
                    .attr("id", "year_value")
                    .attr("class", "year")
                    .attr("opacity", 0.25)
                    .text(display_year);

				//Color the regions
                color = d3.scaleOrdinal()
                    .domain(["Asia", "Europe", "Africa", "North America", "South America", "Australia", "Central America","Oceania" ])
                    .range(["#ff0066", "yellow", "#4db8ff", "#47d147", "#47d147", "#ff0066", "#47d147","#ff0066"]);
                d3.select("#country").on("change",function(){
                    Trace(d3.select(this).property('value'));
                });                                
            }      
			//Function to implement trace of a particular country
            function Trace(arg){
                var dataset_path;

                if (!(arg == '' || arg == null)) {
                    dataset_path = dataset.filter(function(d) {
                        return d.Country == arg;
                    });
                }
                var circles = svg.selectAll("circle")
                    .data(dataset_path, function key(d) {
                        return d.Country;
                    });

                circles.enter()
                    .append("circle")
                    .attr("cx", function(d) {
                        return xScale(+d.GDP);
                    })
                    .attr("cy", function(d) {
                        return yScale(+d.LifeExp);
                    })
                    .attr("r", function(d) {
                        return rScale(+d.Population*1.5);
                    })
                    .attr("stroke-opacity", 0.3)
                    .attr("fill", function(d) {
                        return color(d.Region);
                    })
                    .attr("opacity", 1)
                    .style("stroke", "black");
				circles.exit()
                    .style("opacity", 0.1);
            }
			
			//function to implement bar charts
            function Charts(arg) {
                filtered_dataset = dataset.filter(yearFilter);
                var obj = {};
                var obj1 = {};
                filtered_dataset.forEach(function(d) {
                    var g = d.Government;
                    if (obj1[g] === undefined) {
                        obj1[g] = 1;
                    } else {
                        obj1[g] = obj1[g] + 1;
                    }
                });
                filtered_dataset.forEach(function(d) {
                    var r = d.Region;
                    if (obj[r] === undefined) {
                        obj[r] = 1;
                    } else {
                        obj[r] = obj[r] + 1;
                    }
                });
                xScaleBarhans.domain([0, d3.max(dataset, function(d) { return obj[d.Region];}) ])
                yScaleBarhans.domain(filtered_dataset.map(function(d) { return d.Region; }));

                xScaleBarreg.domain([0, d3.max(dataset, function(d) { return obj1[d.Government];}) ])
                yScaleBarreg.domain(filtered_dataset.map(function(d) { return d.Government; }));


                svg1.select("#x-axis1").call(xAxisBarhans);
                svg1.select("#y-axis1").call(yAxisBarhans);


                svg2.select("#x-axis2").call(xAxisBarreg);
                svg2.select("#y-axis2").call(yAxisBarreg);
				//bars for region bar chart
                var bars1 = svg1.selectAll("rect")
                    .data(filtered_dataset, function key(d) {
                        return d.Region;
                    });
            
                bars1.attr("y", function(d, i) {
                return yScaleBarhans(d.Region);
                   })
                   .attr("x",0)
                   .attr("width", function(d, i) {
                        return xScaleBarhans(obj[d.Region]);
                   })
                   .attr("height", function(d) {
                        return yScaleBarhans.bandwidth();
                   })
                   .style("fill", "blue");
       
                bars1.enter()
                   .append("rect")
                   .attr("y", function(d, i) {
                        return yScaleBarhans(d.Region);
                   })
                   .attr("x",0)
                   .attr("width", function(d, i) {
                        return xScaleBarhans(obj[d.Region]);
                   })
                   .attr("height", function(d) {
                        return yScaleBarhans.bandwidth();
                   })
                   .style("fill", "blue");

                bars1.exit().remove();

				///bar for government types bar chart 
                bars2.attr("y", function(d, i) {
                return yScaleBarreg(d.Government);
                   })
                   .attr("x",0)
                   .attr("width", function(d, i) {
                        return xScaleBarreg(obj1[d.Government]);
                   })
                   .attr("height", function(d) {
                        return yScaleBarreg.bandwidth();
                   })
                   .style("fill", "Green");
       
                bars2.enter()
                   .append("rect")
                   .attr("y", function(d, i) {
                        return yScaleBarreg(d.Government);
                   })
                   .attr("x",0)
                   .attr("width", function(d, i) {
                        return xScaleBarreg(obj1[d.Government]);
                   })
                   .attr("height", function(d) {
                        return yScaleBarreg.bandwidth();
                   })
                   .style("fill", "Green");

                bars2.exit().remove();                
            }
			
			// function to draw the chart
            function generateVis() {
                // Filter the data to only include the current year
			filtered_dataset = dataset.filter(yearFilter);
              filtered_dataset = filtered_dataset.filter(regionFilter);
                            document.getElementById("year").value = display_year;

                d3.select("#country").selectAll("option")
                    .data(d3.map(filtered_dataset, function(d){return d.Country;}).keys())
                    .enter()
                    .append("option")
                    .text(function(d){return d;})
                    .attr("value",function(d){return d;});
                            
                var circles = svg.selectAll("circle")
                    .data(filtered_dataset, function key(d) {
                        return d.Country;
                    });                

                circles.transition()
                    .duration(1000)
                    .ease(d3.easeLinear)
                    .attr("cx", function(d) {
                        return xScale(+d.GDP);
                    })
                    .attr("cy", function(d) {
                        return yScale(+d.LifeExp);
                    })
                    .attr("r", function(d) {
                        return rScale(+d.Population*1.5);
                    })
                    .style("stroke", "black")
                    .style("stroke-width", 1)
                    .style("opacity", function(d){return(+d.Population);})
                    .style("stroke-opacity", 0.5)
                    .attr("fill", function(d) {
                        return color(d.Region);
                    });

                svg.select("#year_value")
                    .attr("y", svg_height / 1)
                    .attr("x", svg_width /1.5)
                    .style("text-anchor", "middle")
                    .attr("class", "year")
                    .text(display_year);
                // Create new elements in the dataset
                circles.enter()
                    .append("circle")
                    .attr("cx", function(d) {
                        return xScale(+d.GDP);
                    })
                    .attr("cy", function(d) {
                        return yScale(+d.LifeExp);
                    })
                    .attr("r", function(d) {
                        return rScale(+d.Population*1.5);
                    })
                    .attr("stroke-opacity", 0.5)
                    .attr("fill", function(d) {
                        return color(d.Region);
                    })
                    .attr("opacity", function(d){return(+d.Population);})
                    .style("stroke", "black")
                    .style("stroke-width", 1)
                    .on("mouseover", function(d) {
                        mouseOn(d3.select(this));
                    })
                    .on("mouseout", function(d) {
                        mouseOff(d3.select(this));
                    });
                    
					//what happens when we hover over a country bubble
                var mouseOn = function(arg1) {
                    var circle = arg1;
                    // Transition to increase size of bubble
                    circle.transition()
                        .duration(800).style("opacity", 1)
                        .attr("r", 15).ease(d3.easeLinear);
                    circle.append("title")
                        .text(function(d) {
                            return d.Country+"\nContinent: "+d.Region+"\nArea: "+d.Area+" sq.km"+"\nCoastline: "+d.Coastline+"km"
                });
                   
                    // function to move mouseover item in front of svg if it overlaps
                    d3.selection.prototype.moveToFront = function() {
                        return this.each(function() {
                            this.parentNode.appendChild(this);
                        });
                    };
                };
                var mouseOff = function(arg1) {
                    var circle = arg1;
                    // go back to original size and opacity

                    circle.transition()
                        .duration(500)
                        .ease(d3.easeLinear);

                    generateVis();
                };
                //HANDLE EXIT SELECTION 
                circles.exit()
                    .remove();
            }
            // Load the file data.csv and generate a visualisation based on it
            d3.csv("./Gapminder_All_Time.csv", function(error, data) {

                // handle any data loading errors
                if (error) {
                    console.log("Something went wrong");
                } 
                else {
                    console.log("Data Loaded");
                    dataset = data;
                    Variables();// Generate the Variables
                    generateVis();// Generate the visualisation
                    Charts(); // Generate the charts
                }
            });
			//what happens when we click play button
            var timer;
            d3.select("#play-button")
                .on("click", function() {
                    var button = d3.select(this);
                    if (button.text() == "Pause") {
                        moving = false;
                        clearInterval(timer);
                        button.text("Play");
                    } else {
                        moving = true;
                        timer = setInterval(function() 
                        {
                            if (display_year < 1950) {
                                for (var i = display_year % 10; i < 10; i++) {
                                    display_year++;
                                }
                            } else {
                                display_year++;
                            }
                            if (display_year > 2016) {
                                display_year = 1900;
                            }                            
                            generateVis();
                            Charts();
                        }, 500);
                        button.text("Pause");
                    }
                });
        </script>
    </div>
</body>
</html>